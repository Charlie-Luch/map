<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Zambia â€“ Cholera status by district</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html, body, #map { height: 100%; margin: 0; }
  .control-panel {
    position: absolute; top: 10px; left: 10px; z-index: 9999;
    background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 10px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  .leaflet-container { background: #f8f9fa; }
  .prov-label { font: 700 12px/1.1 Inter, system-ui, sans-serif; color:#222; text-shadow: 0 1px 2px #fff; }
  .lake-label { font: 600 12px/1.1 Inter, system-ui, sans-serif; color:#1F5DAE; text-shadow: 0 1px 2px #fff; }
  .row { display: flex; gap: 8px; align-items: center; margin: 6px 0; }
  .row label { font-size: 13px; }
  #yrval { font-weight: 700; }
</style>
</head>

<body>
<div id="map"></div>

<div class="control-panel">
  <div class="row">
    <label for="year">Year:</label>
    <input id="year" type="range" min="1" max="7" step="1" value="1" />
    <span id="yrval">1</span>
  </div>
  <div class="row"><input id="ck-prov"  type="checkbox" checked> <label for="ck-prov">Province labels</label></div>
  <div class="row"><input id="ck-lake"  type="checkbox" checked> <label for="ck-lake">Lake labels</label></div>
  <div class="row"><input id="ck-neigh" type="checkbox" checked> <label for="ck-neigh">Neighbour borders</label></div>
  <div class="row"><input id="ck-riv"   type="checkbox" checked> <label for="ck-riv">Rivers</label></div>
  <div class="row"><input id="ck-lakes" type="checkbox" checked> <label for="ck-lakes">Lakes</label></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ---- EDIT THIS to match your actual years ----
  const YEARS = [2018,2019,2020,2021,2022,2023,2024];

  // Accept multiple possible property names
  const STATUS_KEYS  = ["status","Status","STATUS","cholera_status","Status_txt"];
  const NAME_KEYS    = ["District","district","DISTRICT","NAME_2","ADM2_NAME","ADM2","name","NAME"];

  function pickProp(obj, keys, fallback = "") {
    if (!obj) return fallback;
    for (const k of keys) {
      if (Object.hasOwn(obj, k) && obj[k] != null) return String(obj[k]);
    }
    return fallback;
  }

  function statusColor(s){
    if (s === "Eliminated") return "seashell";
    if (s === "Endemic")    return "tomato";
    if (s === "No data")    return "#e5e5e5";
    return "#cccccc"; // fallback
  }

  let map, districtsLayer, provLabelLayer, lakeLabelLayer, neighLayer, riversLayer, lakesLayer;

  function addLegend(){
    const ctrl = L.control({position:"bottomright"});
    ctrl.onAdd = function(){
      const div = L.DomUtil.create("div","leaflet-control leaflet-bar");
      div.style.background = "white";
      div.style.padding = "8px 10px";
      div.style.borderRadius = "8px";
      div.style.font = "12px/1.2 system-ui, sans-serif";
      div.innerHTML = `
        <div style="font-weight:700;margin-bottom:6px;">Status</div>
        <div><span style="display:inline-block;width:14px;height:14px;background:${statusColor("Eliminated")};border:1px solid #666;margin-right:6px;"></span>Eliminated</div>
        <div><span style="display:inline-block;width:14px;height:14px;background:${statusColor("Endemic")};border:1px solid #666;margin-right:6px;"></span>Endemic</div>
        <div><span style="display:inline-block;width:14px;height:14px;background:${statusColor("No data")};border:1px solid #666;margin-right:6px;"></span>No data</div>
      `;
      return div;
    };
    ctrl.addTo(map);
  }

  function initMap(){
    map = L.map("map").setView([-13.1, 27.8], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18, attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Overlays (load if present; ignore if missing)
    fetch("geo/neigh_borders.geojson").then(r => r.ok ? r.json() : null).then(j => {
      if (j) neighLayer  = L.geoJSON(j, {style:{color:"#6f6f6f",weight:0.8}}).addTo(map);
    });
    fetch("geo/rivers.geojson").then(r => r.ok ? r.json() : null).then(j => {
      if (j) riversLayer = L.geoJSON(j, {style:{color:"#1F5DAE",weight:1.2,opacity:0.9}}).addTo(map);
    });
    fetch("geo/lakes.geojson").then(r => r.ok ? r.json() : null).then(j => {
      if (j) lakesLayer  = L.geoJSON(j, {style:{color:"#1F5DAE",weight:0,fillColor:"#1F5DAE",fillOpacity:0.65}}).addTo(map);
    });

    // Province & lake label points (DivIcon)
    fetch("geo/province_labels.geojson").then(r => r.ok ? r.json() : null).then(j => {
      if (j) provLabelLayer = L.geoJSON(j, {
        pointToLayer: (f, latlng) => L.marker(latlng, { icon: L.divIcon({className:"prov-label", html: f.properties.name}) })
      }).addTo(map);
    });
    fetch("geo/lake_labels.geojson").then(r => r.ok ? r.json() : null).then(j => {
      if (j) lakeLabelLayer = L.geoJSON(j, {
        pointToLayer: (f, latlng) => L.marker(latlng, { icon: L.divIcon({className:"lake-label", html: (f.properties.lake || f.properties.name || "")}) })
      }).addTo(map);
    });

    addLegend();
  }

  async function loadYear(y){
    if (!map) initMap();
    if (districtsLayer) map.removeLayer(districtsLayer);

    const url = `geo/districts_${y}.geojson`;
    const resp = await fetch(url);
    if (!resp.ok) {
      console.error("Missing GeoJSON:", url);
      alert(`No data file found for year ${y}.\nI looked for ${url}.`);
      return;
    }
    const geo  = await resp.json();

    districtsLayer = L.geoJSON(geo, {
      style: f => {
        const s = pickProp(f.properties, STATUS_KEYS, "No data");
        return { color:"#666", weight:0.5, fillOpacity:0.8, fillColor: statusColor(s) };
      },
      onEachFeature: (f, layer) => {
        const s = pickProp(f.properties, STATUS_KEYS, "No data");
        const n = pickProp(f.properties, NAME_KEYS, "");
        layer.bindPopup(`<b>${n}</b><br>Status: ${s}<br>Year: ${y}`);
      }
    }).addTo(map);

    try { map.fitBounds(districtsLayer.getBounds(), {padding:[10,10]}); } catch(e) {}
  }

  // Wire the slider to real years
  document.addEventListener("DOMContentLoaded", () => {
    initMap();
    const slider = document.getElementById("year");
    const yrval  = document.getElementById("yrval");
    slider.min   = Math.min(...YEARS);
    slider.max   = Math.max(...YEARS);
    slider.value = YEARS[0];
    yrval.textContent = slider.value;
    loadYear(Number(slider.value));
    slider.addEventListener("input", () => {
      yrval.textContent = slider.value;
      loadYear(Number(slider.value));
    });
  });
</script>
</body>
</html>

